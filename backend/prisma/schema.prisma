// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// --- Reset id sequence ---
// This lists sequences for your table
// SELECT pg_get_serial_sequence('users', 'id');
//
// Example output
// pg_get_serial_sequence
// -----------------------
// public.users_id_seq
//
// You can reset it manually so the next inserted row gets the correct id
// ALTER SEQUENCE users_id_seq RESTART WITH 1;
//


model users {
  id              Int                 @id @default(autoincrement())
  name            String              @db.Text
  email           String              @unique @db.Text
  hashed_password String              @db.Text

  subscription    subscription?       
  billing_history billing_history[]   
  code            code[]              // all code submissions by the user

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt @default(now())
  deletedAt       DateTime?


}

model subscription {
  id                    Int         @id @default(autoincrement())
  usersId               Int         @unique
  users                 users       @relation(fields: [usersId], references: [id], onDelete: Cascade)

  tier                  String      @default("free")  // free/pro/unlimited
  daily_scan_limit      Int?        @default(10)      // 10, 25, NULL for unlimited
  scans_used_today      Int         @default(0)
  last_reset_date       DateTime?                     // NULL for new users
  status                String                        // Active, none
  renewal_date          DateTime?
  stripe_subscriptionId String?     @map("stripe_subscription_id")
  
  createdAt             DateTime    @default(now())
}

model billing_history {
  id                Int       @id @default(autoincrement())
  usersId           Int    
  users             users     @relation(fields: [usersId], references:[id], onDelete: Cascade)

  amount            Int       // smallest currency unlimited
  currency          String
  date              DateTime  @default(now())
  stripe_eventId    String?   @unique
  event_type        String?
}

model code {
  id            Int       @id @default(autoincrement())
  usersId       Int    
  users         users     @relation(fields: [usersId], references:[id], onDelete: Cascade)

  code_input    String
  code_output   String
  language      String
  refactors     refactor[]

  createdAt   DateTime  @default(now())
}

model refactor {
  id          Int       @id @default(autoincrement())
  codeId      Int    
  code        code      @relation(fields: [codeId], references: [id], onDelete: Cascade)

  refactored_code       String

  createdAt   DateTime  @default(now())
}